<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>TAG THE WALL</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
  <link rel="icon" href="data:,">
  <style>
    :root{
      --bg:#000; --crt:#00ff00; --crt-dim:rgba(0,255,0,.55); --crt-soft: rgba(0,255,0,.18);
      --fs:20px; --ls:.08em; --lh:1.3;
      --stage-offset:56px; --wrap-w:94vw; --max-w:1600px; --left-offset:1in;
      --sep-title:24px; --between-q:18px; --row-gap:12px; --caret-gap:1ch; --btn-w:240px;
    }
    *{ box-sizing:border-box }
    html,body{ height:100%; margin:0 }
    body{
      background:var(--bg); color:var(--crt);
      font-family:'DotGothic16',system-ui,monospace;
      text-transform:uppercase; letter-spacing:var(--ls); font-size:var(--fs);
      line-height:calc(var(--lh)*1em);
    }
    .wrap{
      width:var(--wrap-w); max-width:var(--max-w);
      margin:calc(var(--stage-offset)) auto 32px;
      padding:0 calc(12px + var(--left-offset)); /* symmetric left/right */
    }
    /* Header row: left title, right back link — perfectly aligned by the same padding */
    .hdr{ display:flex; align-items:baseline; justify-content:space-between; }
    h1{ margin:0; font-weight:700; font-size:var(--fs); line-height:calc(var(--lh)*1em); }
    .back-link{ color:var(--crt); text-decoration:none; font-weight:700; }
    .back-link .label{ text-decoration:none; }
    .back-link .bracket{ text-decoration:none; }
    .back-link:hover .label{ text-decoration:underline; }
    .spacer-title{ height: var(--sep-title); }

    .row-spacer{ height: var(--between-q); } /* extra space above each question */

    .q{ margin-top: var(--between-q); }
    .line{ display:flex; align-items:baseline; gap:var(--caret-gap); margin-top:var(--row-gap); }
    .no-caret .caret{ display:none; }

    .typed{ min-height:calc(var(--lh)*1em); line-height:calc(var(--lh)*1em); white-space:pre-wrap; color:var(--crt); }
    .typed.ph{ color:var(--crt-dim); }

    /* Inline block-cursor that sits over the character at the caret */
    .cursor-block{
      display:inline-block; width:1.1ch; height:1em;
      background:var(--crt); color:#000;
      transform: translateY(calc((var(--lh) - 1) * 0.5em));
      animation: cursorBlink .8s steps(1,end) infinite; vertical-align:baseline;
    }
    @keyframes cursorBlink{0%,45%{background:var(--crt);color:#000}50%,100%{background:transparent;color:transparent}}

    .btn{ display:inline-block; width:var(--btn-w); padding:10px 14px; background:var(--bg); color:var(--crt);
          border:1px solid var(--crt); font:inherit; font-weight:700; text-align:center; cursor:pointer; user-select:none; white-space:nowrap;}
    .btn:hover,.btn:focus,.btn:active{ background: var(--crt-soft); box-shadow: 0 0 0 2px var(--crt-soft) inset; outline: none; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    input[type="file"]{ display:none }
    .file-status{ margin-left:12px; font-style:italic; color:var(--crt-dim); text-transform:none; white-space:nowrap; }

    /* success/error spot next to GO */
    .status{ display:inline-block; margin-left:14px; font-style:italic; white-space:nowrap; vertical-align:baseline; color:var(--crt); text-transform:lowercase; }

    .hid-input{ position:absolute; left:-9999px; width:1px; height:1px; opacity:0; border:0; outline:none; background:transparent; color:transparent; caret-color:transparent; text-transform:lowercase; }
    .hp{ position:absolute; left:-9999px; top:-9999px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hdr">
      <h1>*** TAG THE WALL ***</h1>
      <a class="back-link" href="https://rawechelonform.neocities.org/girlsroom">
        <span class="bracket">&lt;</span><span class="label">BACK</span><span class="bracket">&gt;</span>
      </a>
    </div>
    <div class="spacer-title"></div>

    <!-- Hidden iframe target -->
    <iframe name="upload_iframe" style="display:none"></iframe>

    <!-- Native POST to Apps Script -->
    <form id="tags_form"
      action="https://script.google.com/macros/s/AKfycbxv3FKB0P30wixxKJUfYvTnCW9vzqgar4JV7PArIpirC9lk7Srpqe3SNDKIcCIvjs_4/exec"
      method="POST" enctype="multipart/form-data" target="upload_iframe" novalidate>

      <!-- UPLOAD -->
      <div class="row-spacer"></div>
      <div class="q">UPLOAD IMAGE</div>
      <div class="line no-caret">
        <span class="caret">></span>
        <label for="sticker" class="btn">UPLOAD IMAGE</label>
        <input id="sticker" type="file" name="sticker" accept=".png,.jpg,.jpeg,.webp" required />
        <span id="fileStatus" class="file-status"></span>
      </div>

      <!-- base64 fallback fields -->
      <input type="hidden" name="sticker_b64" id="sticker_b64">
      <input type="hidden" name="sticker_name" id="sticker_name">
      <input type="hidden" name="sticker_type" id="sticker_type">

      <!-- PLACE OF TAG -->
      <div class="row-spacer"></div>
      <div class="q">PLACE OF TAG</div>
      <div class="line" data-field="title" data-ph="'ZËRGË COFFEESHOP', 'BERLIN WALL', 'STRIPPER POLE' (optional)">
        <span class="caret">></span>
        <div class="typed" id="typed-title"></div>
        <input id="hid-title" class="hid-input" type="text" name="title" maxlength="30" autocomplete="off" autocapitalize="off" spellcheck="false">
      </div>

      <!-- CITY -->
      <div class="row-spacer"></div>
      <div class="q">CITY</div>
      <div class="line" data-field="city" data-ph="NEW YORK CITY">
        <span class="caret">></span>
        <div class="typed" id="typed-city"></div>
        <input id="hid-city" class="hid-input" type="text" name="city" maxlength="30" autocomplete="address-level2" autocapitalize="off" spellcheck="false">
      </div>

      <!-- COUNTRY -->
      <div class="row-spacer"></div>
      <div class="q">COUNTRY</div>
      <div class="line" data-field="country" data-ph="USA">
        <span class="caret">></span>
        <div class="typed" id="typed-country"></div>
        <input id="hid-country" class="hid-input" type="text" name="country" maxlength="30" autocomplete="country-name" autocapitalize="off" spellcheck="false">
      </div>

      <!-- Honeypot -->
      <input class="hp" type="text" name="website" tabindex="-1" autocomplete="off" />

      <!-- GO + inline status -->
      <div class="row-spacer"></div>
      <div class="line no-caret">
        <span class="caret">></span>
        <button id="submitBtn" type="submit" class="btn">GO</button>
        <span id="status" class="status"></span>
      </div>
    </form>
  </div>

  <script>
    // ===== caret-following renderer for typed fields =====
    function escapeHTML(s){
      return String(s).replace(/[&<>"']/g, c => (
        c === '&' ? '&amp;' : c === '<' ? '&lt;' : c === '>' ? '&gt;' : c === '"' ? '&quot;' : '&#39;'
      ));
    }
    function bindTermField(field){
      var line  = document.querySelector('.line[data-field="' + field + '"]');
      if (!line) return;
      var typed = line.querySelector('.typed');
      var input = document.getElementById('hid-' + field);
      var ph    = line.getAttribute('data-ph') || '';

      line.addEventListener('click', function(){ input.focus(); });

      function render(showPh, withCursor){
        if (showPh === undefined) showPh = true;
        var raw = (input.value || '').toLowerCase().slice(0,30);
        var v   = raw.toUpperCase();

        if (!raw && showPh){
          typed.textContent = ph;
          typed.classList.add('ph');
          return;
        }
        typed.classList.remove('ph');

        if (withCursor && document.activeElement === input){
          var idx = input.selectionStart != null ? input.selectionStart : v.length;
          // Clamp idx
          if (idx < 0) idx = 0;
          if (idx > v.length) idx = v.length;

          var before = escapeHTML(v.slice(0, idx));
          var atChar = v.slice(idx, idx+1);
          var middle = '<span class="cursor-block">' + (atChar ? escapeHTML(atChar) : '&nbsp;') + '</span>';
          var after  = escapeHTML(v.slice(idx + (atChar ? 1 : 0)));
          typed.innerHTML = before + middle + after;
        } else {
          typed.textContent = v;
        }
      }

      // keep model in lowercase, render uppercase
      input.addEventListener('input', function(){
        input.value = (input.value || '').toLowerCase().slice(0,30);
        render(false, true);
      });
      input.addEventListener('focus', function(){ render(false, true); });
      input.addEventListener('blur',  function(){ render(true,  false); });
      input.addEventListener('keyup', function(){ render(false, true); });
      input.addEventListener('click', function(){ render(false, true); });
      document.addEventListener('selectionchange', function(){
        if (document.activeElement === input) render(false, true);
      });

      render(true, false);
    }
    ['title','city','country'].forEach(bindTermField);

    // ===== upload logic (unchanged behavior, includes base64 fallback + fail-safe) =====
    var form       = document.getElementById('tags_form');
    var btn        = document.getElementById('submitBtn');
    var statusEl   = document.getElementById('status');
    var fileInput  = document.getElementById('sticker');
    var fileStatus = document.getElementById('fileStatus');

    var b64El  = document.getElementById('sticker_b64');
    var nameEl = document.getElementById('sticker_name');
    var typeEl = document.getElementById('sticker_type');

    var MAX_SIZE = 5 * 1024 * 1024; // 5 MB
    var uploadTimer = null;

    function setStatus(msg){ statusEl.textContent = msg; }
    function prettyBytes(n){ if(n==null)return''; var u=['B','KB','MB','GB']; var i=0; var v=n; while(v>=1024&&i<u.length-1){v/=1024;i++;} return (i?v.toFixed(1):v.toFixed(0))+' '+u[i]; }

    // immediate size check
    fileInput.addEventListener('change', function(){
      var f = fileInput.files && fileInput.files[0];
      b64El.value = ''; nameEl.value = ''; typeEl.value = '';
      setStatus('');
      if (!f){ fileStatus.textContent = ''; btn.disabled = false; return; }
      if (f.size > MAX_SIZE){
        fileStatus.textContent = 'file size limit: 5 mb';
        btn.disabled = true;
      } else {
        fileStatus.textContent = 'selected: ' + f.name + ' (' + prettyBytes(f.size) + ')';
        btn.disabled = false;
      }
    });

    function readFileToBase64(file){
      return new Promise(function(resolve,reject){
        var r = new FileReader();
        r.onload = function(){ resolve(String(r.result||'')); };
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    var reading = false;
    form.addEventListener('submit', async function(e){
      var f = fileInput.files && fileInput.files[0];
      if (!f){ e.preventDefault(); setStatus('no image uploaded.'); return; }
      if (f.size > MAX_SIZE){ e.preventDefault(); setStatus('file size limit: 5 mb'); return; }
      if (!['image/png','image/jpeg','image/webp'].includes(f.type)){
        e.preventDefault(); setStatus('png/jpeg/webp only'); return; }
      var hp = document.querySelector('input[name="website"]'); if (hp && hp.value){
        e.preventDefault(); setStatus('spam blocked.'); return; }

      if (!b64El.value && !reading) {
        e.preventDefault();
        reading = true;
        btn.disabled = true; setStatus('prepping upload...');
        try {
          var dataUrl = await readFileToBase64(f);
          var parts = dataUrl.split(',', 2);
          b64El.value  = parts[1] || '';
          nameEl.value = f.name || 'upload';
          typeEl.value = f.type || 'application/octet-stream';
          reading = false;
          btn.disabled = false; setStatus('uploading...');
          clearTimeout(uploadTimer);
          uploadTimer = setTimeout(function(){
            setStatus('tag submitted. it may take a few days to see tag added to the wall.');
            btn.disabled = false;
          }, 20000);
          form.submit();
        } catch (err) {
          reading = false; btn.disabled = false; setStatus('failed to read file.');
        }
      } else {
        setStatus('uploading...');
        clearTimeout(uploadTimer);
        uploadTimer = setTimeout(function(){
          setStatus('tag submitted. it may take a few days to see tag added to the wall.');
          btn.disabled = false;
        }, 20000);
      }
    });

    // postMessage from Apps Script
    window.addEventListener('message', function(e){
      var okOrigin =
        /^https:\/\/script\.google\.com$/.test(e.origin) ||
        /^https:\/\/([a-z0-9-]+\.)*googleusercontent\.com$/.test(e.origin);
      if (!okOrigin) return;

      var d = e.data || {};
      if (d.source !== 'tags-webapp') return;

      clearTimeout(uploadTimer);
      btn.disabled = false;

      if (d.ok) {
        setStatus('tag submitted. it may take a few days to see tag added to the wall.');
        form.reset();
        fileStatus.textContent = '';
        // reset typed placeholders
        ['title','city','country'].forEach(function(fld){
          var line = document.querySelector('.line[data-field="' + fld + '"]');
          var typed = line && line.querySelector('.typed');
          var ph = line && line.getAttribute('data-ph');
          if (typed && ph){ typed.textContent = ph; typed.classList.add('ph'); }
        });
      } else {
        setStatus(d.error ? String(d.error).toLowerCase() : 'upload failed.');
      }
    });
  </script>
</body>
</html>
