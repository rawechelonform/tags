<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <meta name="theme-color" content="#000000">
  <title>TAG THE WALL</title>
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
  <link rel="icon" href="data:,">
  <style>
    :root{
      --bg:#000;
      --crt:#00ff00;                /* bright green accents (borders, cursor, etc.) */
      --ink:#00c400;                /* darker green for typed text */
      --ph:rgba(0,235,0,.25);       /* dimmer green for placeholders */
      --crt-dim:rgba(0,255,0,.55);  /* muted accent for helper/status */
      --crt-soft:rgba(0,255,0,.18);
      --fs:20px;
      --ls:.08em; --lh:1.3;
      --stage-offset:56px; --wrap-w:94vw; --max-w:1600px; --left-offset:1in;
      --sep-title:24px; --between-q:18px; --row-gap:12px; --caret-gap:1ch; --btn-w:240px;
    }
    *{ box-sizing:border-box }
    html,body{
      height:100%; margin:0; background:var(--bg) !important; color:var(--crt);
      font-family:'DotGothic16',system-ui,monospace;
      text-transform:uppercase; letter-spacing:var(--ls); font-size:var(--fs);
      line-height:calc(var(--lh)*1em);
    }

    /* Fluid base font so text scales desktop→mobile */
    :root{ --fs: clamp(14px, 1.8vw, 20px); }

    .wrap{
      width:var(--wrap-w); max-width:var(--max-w);
      margin:0 auto 32px;
      padding:var(--stage-offset) calc(12px + var(--left-offset)) 0;
    }

    .hdr{ display:flex; align-items:baseline; justify-content:space-between; }
    h1{ margin:0; font-weight:700; font-size:var(--fs); line-height:calc(var(--lh)*1em); }
    .back-link{ color:var(--crt); text-decoration:none; font-weight:700; }
    .back-link .label{ text-decoration:none; }
    .back-link .bracket{ text-decoration:none; }
    .back-link:hover .label{ text-decoration:underline; }
    .spacer-title{ height: var(--sep-title); }

    .row-spacer{ height: var(--between-q); }
    .q{ margin-top: var(--between-q); }
    .line{ display:flex; align-items:baseline; gap:var(--caret-gap); margin-top:var(--row-gap); }
    .no-caret .caret{ display:none; }

    .typed{ min-height:calc(var(--lh)*1em); line-height:calc(var(--lh)*1em); white-space:pre-wrap; color:var(--ink); }
    .typed.ph{ color:var(--ph); }  /* dimmer placeholder */

    .cursor-block{ display:inline-block; width:1.1ch; height:1em; background:var(--crt); color:#000;
                   transform: translateY(calc((var(--lh) - 1) * 0.5em));
                   animation: cursorBlink .8s steps(1,end) infinite; vertical-align:baseline; }
    @keyframes cursorBlink{0%,45%{background:var(--crt);color:#000}50%,100%{background:transparent;color:transparent}}

    .btn{ display:inline-block; width:var(--btn-w); padding:10px 14px; background:var(--bg); color:var(--crt);
          border:1px solid var(--crt); font:inherit; font-weight:700; text-align:center; cursor:pointer; user-select:none; white-space:nowrap;}
    .btn:hover,.btn:focus,.btn:active{ background: var(--crt-soft); box-shadow: 0 0 0 2px var(--crt-soft) inset; outline: none; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    input[type="file"]{ display:none }
    .file-status{ margin-left:12px; font-style:italic; color:var(--crt-dim); text-transform:none; white-space:nowrap; }
    .status{ display:inline-block; margin-left:14px; font-style:italic; white-space:nowrap; vertical-align:baseline; color:var(--crt); text-transform:lowercase; }

    .hid-input{ position:absolute; left:-9999px; width:1px; height:1px; opacity:0; border:0; outline:none; background:transparent; color:transparent; caret-color:transparent; text-transform:lowercase; }
    .hp{ position:absolute; left:-9999px; top:-9999px; }

    ::placeholder{ color:var(--ph); opacity:0.9; text-transform:uppercase; }

    /* Mobile tweaks */
    @media (max-width: 600px){
      :root{
        --left-offset: 0px;
        --wrap-w: 100vw;
        --fs: 16px;         /* comfy phone size */
        --caret-gap: 0.5ch;
        --stage-offset: 40px;
      }
      /* add a small side margin on phones */
      .wrap{ padding-left:16px; padding-right:16px; }
      .file-status{ white-space:normal; display:block; margin-left:0; margin-top:8px; }
      .line{ gap:0.5ch; align-items:center; }
    }
    @media (max-width: 380px){
      :root{ --fs: 15px; --stage-offset: 32px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hdr">
      <h1>*** TAG THE WALL ***</h1>
      <a class="back-link" href="https://rawechelonform.neocities.org/girlsroom">
        <span class="bracket">&lt;</span><span class="label">BACK</span><span class="bracket">&gt;</span>
      </a>
    </div>
    <div class="spacer-title"></div>

    <iframe name="upload_iframe" style="display:none"></iframe>

    <form id="tags_form"
      action="https://script.google.com/macros/s/AKfycbxv3FKB0P30wixxKJUfYvTnCW9vzqgar4JV7PArIpirC9lk7Srpqe3SNDKIcCIvjs_4/exec"
      method="POST" enctype="multipart/form-data" target="upload_iframe" novalidate>

      <!-- UPLOAD -->
      <div class="row-spacer"></div>
      <div class="q">UPLOAD IMAGE</div>
      <div class="line no-caret">
        <span class="caret">></span>
        <label for="sticker" class="btn">UPLOAD IMAGE</label>
        <input id="sticker" type="file" name="sticker" accept=".png,.jpg,.jpeg" required />
        <span id="fileStatus" class="file-status"></span>
      </div>

      <!-- base64 fallback fields -->
      <input type="hidden" name="sticker_b64" id="sticker_b64">
      <input type="hidden" name="sticker_name" id="sticker_name">
      <input type="hidden" name="sticker_type" id="sticker_type">

      <!-- anti-bot helpers -->
      <input type="hidden" name="ttf_ms" id="ttf_ms">
      <input class="hp" type="text" name="website" tabindex="-1" autocomplete="off" />

      <!-- PLACE OF TAG -->
      <div class="row-spacer"></div>
      <div class="q">PLACE OF TAG</div>
      <div class="line" data-field="title" data-ph="'ZËRGË COFFEESHOP', 'BERLIN WALL', 'STRIPPER POLE' (optional)">
        <span class="caret">></span>
        <div class="typed" id="typed-title"></div>
        <input id="hid-title" class="hid-input" type="text" name="title" maxlength="30" autocomplete="off" autocapitalize="off" spellcheck="false">
      </div>

      <!-- CITY -->
      <div class="row-spacer"></div>
      <div class="q">CITY</div>
      <div class="line" data-field="city" data-ph="NEW YORK CITY">
        <span class="caret">></span>
        <div class="typed" id="typed-city"></div>
        <input id="hid-city" class="hid-input" type="text" name="city" maxlength="30" autocomplete="address-level2" autocapitalize="off" spellcheck="false">
      </div>

      <!-- COUNTRY -->
      <div class="row-spacer"></div>
      <div class="q">COUNTRY</div>
      <div class="line" data-field="country" data-ph="USA">
        <span class="caret">></span>
        <div class="typed" id="typed-country"></div>
        <input id="hid-country" class="hid-input" type="text" name="country" maxlength="30" autocomplete="country-name" autocapitalize="off" spellcheck="false">
      </div>

      <!-- GO + inline status -->
      <div class="row-spacer"></div>
      <div class="line no-caret">
        <span class="caret">></span>
        <button id="submitBtn" type="submit" class="btn">GO</button>
        <span id="status" class="status"></span>
      </div>
    </form>
  </div>

  <script>
    /* caret-following renderer */
    function escapeHTML(s){return String(s).replace(/[&<>"']/g,c=>c==='&'?'&amp;':c==='<'?'&lt;':c==='>'?'&gt;':c==='"'?'&quot;':'&#39;');}
    function bindTermField(field){
      var line=document.querySelector('.line[data-field="'+field+'"]'); if(!line)return;
      var typed=line.querySelector('.typed'); var input=document.getElementById('hid-'+field); var ph=line.getAttribute('data-ph')||'';
      line.addEventListener('click',function(){input.focus();});
      function render(showPh,withCursor){
        if(showPh===undefined)showPh=true;
        var raw=(input.value||'').toLowerCase().slice(0,30), v=raw.toUpperCase();
        if(!raw&&showPh){typed.textContent=ph; typed.classList.add('ph'); return;} typed.classList.remove('ph');
        if(withCursor&&document.activeElement===input){
          var idx=input.selectionStart!=null?input.selectionStart:v.length; if(idx<0)idx=0; if(idx>v.length)idx=v.length;
          var before=escapeHTML(v.slice(0,idx)); var at=v.slice(idx,idx+1); var mid='<span class="cursor-block">'+(at?escapeHTML(at):'&nbsp;')+'</span>';
          var after=escapeHTML(v.slice(idx+(at?1:0))); typed.innerHTML=before+mid+after;
        }else{ typed.textContent=v; }
      }
      input.addEventListener('input',function(){input.value=(input.value||'').toLowerCase().slice(0,30); render(false,true);});
      input.addEventListener('focus',function(){render(false,true);});
      input.addEventListener('blur', function(){render(true,false);});
      input.addEventListener('keyup',function(){render(false,true);});
      input.addEventListener('click',function(){render(false,true);});
      document.addEventListener('selectionchange',function(){ if(document.activeElement===input) render(false,true); });
      render(true,false);
    }
    ['title','city','country'].forEach(bindTermField);

    /* upload + base64 fallback + silent 500KB optimizer */
    var form=document.getElementById('tags_form'), btn=document.getElementById('submitBtn'), statusEl=document.getElementById('status');
    var fileInput=document.getElementById('sticker'), fileStatus=document.getElementById('fileStatus');
    var b64El=document.getElementById('sticker_b64'), nameEl=document.getElementById('sticker_name'), typeEl=document.getElementById('sticker_type');
    var ttfEl=document.getElementById('ttf_ms'), t0=Date.now();

    var CAP_BYTES=500*1024;          // must match server
    var MAX_READ_BYTES=25*1024*1024; // safety: don’t try to process absurdly large files in browser
    var uploadTimer=null;

    function setStatus(m){ statusEl.textContent=m; }
    function prettyBytes(n){ if(n==null)return''; var u=['B','KB','MB','GB'],i=0,v=n; while(v>=1024&&i<u.length-1){v/=1024;i++;} return (i?v.toFixed(1):v.toFixed(0))+' '+u[i]; }

    fileInput.addEventListener('change',function(){
      var f=fileInput.files&&fileInput.files[0]; b64El.value=''; nameEl.value=''; typeEl.value=''; setStatus('');
      if(!f){ fileStatus.textContent=''; btn.disabled=false; return; }
      if(!['image/jpeg','image/png'].includes(f.type)){ fileStatus.textContent='png/jpeg only'; btn.disabled=true; return; }
      if(f.size>MAX_READ_BYTES){ fileStatus.textContent='file too large to process in browser'; btn.disabled=true; return; }
      fileStatus.textContent='selected: '+f.name+' ('+prettyBytes(f.size)+')';
      btn.disabled=false;
    });

    function readFileToDataURL(file){ return new Promise(function(resolve,reject){ var r=new FileReader(); r.onload=function(){resolve(String(r.result||''));}; r.onerror=reject; r.readAsDataURL(file); }); }
    function loadImage(src){ return new Promise(function(resolve,reject){ var img=new Image(); img.onload=function(){resolve(img)}; img.onerror=reject; img.src=src; }); }

    async function optimizeToCap(file){
      // pass-through if already small JPEG
      if (file.type==='image/jpeg' && file.size<=CAP_BYTES){
        var pass = await readFileToDataURL(file);
        return { dataUrl: pass, name: file.name || 'upload.jpg', type: 'image/jpeg' };
      }
      // convert/draw to canvas → JPEG under cap
      var dataUrl = await readFileToDataURL(file);
      var img = await loadImage(dataUrl);

      var MAX_DIM = 2000; // cap long edge for giant photos
      var scale = Math.min(1, MAX_DIM / Math.max(img.width, img.height));
      var cw = Math.max(1, Math.round(img.width*scale));
      var ch = Math.max(1, Math.round(img.height*scale));

      var canvas=document.createElement('canvas'); canvas.width=cw; canvas.height=ch;
      var ctx=canvas.getContext('2d');
      ctx.fillStyle='#000'; ctx.fillRect(0,0,cw,ch); // replace transparency with black
      ctx.drawImage(img,0,0,cw,ch);

      var quality=0.9, out, estBytes=Infinity;
      while (quality>=0.4){
        out = canvas.toDataURL('image/jpeg', quality);
        estBytes = Math.ceil((out.length - 'data:image/jpeg;base64,'.length)*3/4);
        if (estBytes <= CAP_BYTES) break;
        quality -= 0.1;
      }
      var name=(file.name||'upload').replace(/\.[^.]+$/,'')+'.jpg';
      return { dataUrl: out, name: name, type: 'image/jpeg' };
    }

    var prepping=false;
    form.addEventListener('submit', async function(e){
      ttfEl.value = String(Math.max(0, Date.now()-t0));
      var f=fileInput.files&&fileInput.files[0];
      if(!f){ e.preventDefault(); setStatus('no image uploaded.'); return; }
      if(!['image/jpeg','image/png'].includes(f.type)){ e.preventDefault(); setStatus('png/jpeg only'); return; }
      var hp=document.querySelector('input[name="website"]'); if(hp&&hp.value){ e.preventDefault(); setStatus('spam blocked.'); return; }
      if(f.size>MAX_READ_BYTES){ e.preventDefault(); setStatus('file too large to process in browser'); return; }

      if(!b64El.value && !prepping){
        e.preventDefault(); prepping=true; btn.disabled=true; setStatus('prepping upload...');
        try{
          var opt = await optimizeToCap(f);
          b64El.value = (opt.dataUrl.split(',',2)[1]) || '';
          nameEl.value = opt.name || (f.name||'upload');
          typeEl.value = opt.type || 'image/jpeg';

          prepping=false; btn.disabled=false; setStatus('uploading...');
          clearTimeout(uploadTimer);
          uploadTimer=setTimeout(function(){ setStatus('tag submitted. it may take a few days to see tag added to the wall.'); btn.disabled=false; }, 20000);
          form.submit();
        }catch(err){
          prepping=false; btn.disabled=false; setStatus('failed to process image.');
        }
      } else {
        setStatus('uploading...');
        clearTimeout(uploadTimer);
        uploadTimer=setTimeout(function(){ setStatus('tag submitted. it may take a few days to see tag added to the wall.'); btn.disabled=false; }, 20000);
      }
    });

    // receive postMessage from the Apps Script iframe
    window.addEventListener('message',function(e){
      var okOrigin=/^https:\/\/script\.google\.com$/.test(e.origin)||/^https:\/\/([a-z0-9-]+\.)*googleusercontent\.com$/.test(e.origin);
      if(!okOrigin) return;
      var d=e.data||{}; if(d.source!=='tags-webapp') return;
      clearTimeout(uploadTimer); btn.disabled=false;
      if(d.ok){
        setStatus('tag submitted. it may take a few days to see tag added to the wall.');
        form.reset(); fileStatus.textContent='';
        ['title','city','country'].forEach(function(fld){
          var line=document.querySelector('.line[data-field="'+fld+'"]');
          var typed=line&&line.querySelector('.typed'); var ph=line&&line.getAttribute('data-ph');
          if(typed&&ph){ typed.textContent=ph; typed.classList.add('ph'); }
        });
      } else {
        setStatus(d.error ? String(d.error).toLowerCase() : 'upload failed.');
      }
    });
  </script>
</body>
</html>
