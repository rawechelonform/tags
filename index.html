// ===== CONFIG =====
const FOLDER_ID = '1nbYQ_Pep54RrJ_0Tr2eip6_3sAlGqm1h'; // your Drive folder

function doGet() {
  return HtmlService.createHtmlOutput('uploader ready');
}

// Minimal iframe reply (no visible content)
function replyToParent(payload) {
  var targetOrigin = 'https://rawechelonform.github.io';
  var msg = JSON.stringify(Object.assign({ source: 'tags-webapp' }, payload));
  var html =
    '<!doctype html><meta charset="utf-8">' +
    '<script>try{window.top.postMessage(' + msg + ", '" + targetOrigin + "');}catch(e){}</script>";
  return HtmlService.createHtmlOutput(html)
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL)
    .setSandboxMode(HtmlService.SandboxMode.IFRAME);
}

function doPost(e) {
  var debug = {
    hasE: !!e,
    postDataType: e && e.postData ? e.postData.type : 'none',
    postDataLength: e && e.postData ? e.postData.length : 'none',
    filesKeys: e && e.files ? Object.keys(e.files) : [],
    params: e && e.parameters ? e.parameters : {}
  };

  try {
    var blob = null;
    var origName = '';
    var mime = '';

    // Normal multipart
    if (e && e.files && e.files.sticker) {
      blob = e.files.sticker;
      origName = blob.getName() || '';
      mime = blob.getContentType() || '';
    }

    // Base64 fallback
    if (!blob && e && e.parameters && e.parameters.sticker_b64 && e.parameters.sticker_b64.length) {
      var b64 = e.parameters.sticker_b64[0];
      mime = (e.parameters.sticker_type && e.parameters.sticker_type[0]) || 'application/octet-stream';
      origName = (e.parameters.sticker_name && e.parameters.sticker_name[0]) || 'upload';
      var bytes = Utilities.base64Decode(b64);
      blob = Utilities.newBlob(bytes, mime, origName);
    }

    if (!blob) {
      return replyToParent({ ok: false, error: 'no image uploaded', debug: debug });
    }

    // ----- Build filename: place_of_tag-city-country.ext -----
    function slug(s) {
      return String(s || '')
        .toLowerCase()
        .trim()
        .replace(/\s+/g, '_')      // spaces -> underscore
        .replace(/[^a-z0-9_]/g, ''); // keep only a-z, 0-9, _
    }

    var p = e.parameters || {};
    var title   = (p.title   && p.title[0])   || '';
    var city    = (p.city    && p.city[0])    || '';
    var country = (p.country && p.country[0]) || '';

    var parts = [slug(title), slug(city), slug(country)].filter(Boolean);
    var base  = parts.join('-'); // join with hyphens
    // if all are blank, base becomes empty string

    function extFromMime(m) {
      if (/jpeg/i.test(m)) return 'jpg';
      if (/png/i.test(m))  return 'png';
      if (/webp/i.test(m)) return 'webp';
      return '';
    }
    function extFromName(n) {
      var m = /\.[A-Za-z0-9]+$/.exec(n || '');
      return m ? m[0].slice(1).toLowerCase() : '';
    }

    var ext = extFromName(origName) || extFromMime(mime) || '';
    var finalName = base ? (ext ? base + '.' + ext : base) : (origName || 'upload');

    // Save
    var folder = DriveApp.getFolderById(FOLDER_ID);
    var file = folder.createFile(blob).setName(finalName);

    return replyToParent({ ok: true, fileId: file.getId(), name: file.getName(), debug: debug });
  } catch (err) {
    return replyToParent({ ok: false, error: String(err), debug: debug });
  }
}
