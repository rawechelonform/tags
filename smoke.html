<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Smoke Test — Tags Uploader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{ --fg:#0f0; --bg:#000; --mut:#8f8; }
    html,body{ margin:0; background:var(--bg); color:var(--fg); font:14px/1.4 monospace; }
    .wrap{ max-width:900px; margin:24px auto; padding:0 16px; }
    h1{ margin:0 0 16px 0; font-size:18px; }
    fieldset{ border:1px dashed var(--fg); padding:12px; margin:14px 0; }
    legend{ padding:0 6px; color:var(--mut); }
    label{ display:block; margin:8px 0; }
    .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    input[type="text"]{ padding:6px 8px; border:1px solid var(--fg); background:transparent; color:var(--fg); width:280px; }
    input[type="file"]{ color:var(--fg); }
    button{ padding:8px 14px; border:1px solid var(--fg); background:transparent; color:var(--fg); cursor:pointer; }
    button:hover{ background:#002800; }
    .help{ color:var(--mut); font-style:italic; }
    pre{ white-space:pre-wrap; word-break:break-word; background:#001800; padding:8px; border:1px dashed var(--fg); }
    iframe{ width:100%; height:110px; border:1px dashed var(--fg); background:#050; }
    .pill{ display:inline-block; border:1px solid var(--fg); padding:2px 6px; margin-left:6px; color:var(--mut); }
    .err{ color:#f66; }
    .ok{ color:#7f7; }
    .muted{ color:var(--mut); }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Smoke Test — Tags Uploader
      <span class="pill" id="showAction"></span>
    </h1>

    <iframe name="upload_iframe" id="upload_iframe"></iframe>

    <form id="tags_form"
      action="https://script.google.com/macros/s/AKfycbxv3FKB0P30wixxKJUfTnCW9vzqgar4JV7PArIpirC9lk7Srpqe3SNDKIcCIvjs_4/exec".replace("Tn","")
      method="POST" enctype="multipart/form-data" target="upload_iframe" novalidate>

      <fieldset>
        <legend>File</legend>
        <div class="row">
          <input id="sticker" type="file" name="sticker" accept=".jpg,.jpeg,.png" required>
          <span id="fileMsg" class="help"></span>
        </div>
        <div class="help">Only JPEG/PNG, max <strong>500 KB</strong>. If larger, we’ll auto-optimize.</div>
      </fieldset>

      <fieldset>
        <legend>Metadata</legend>
        <label>Place of tag <input type="text" name="title" placeholder="e.g., zërgë coffeeshop"></label>
        <label>City <input type="text" name="city" placeholder="e.g., berlin"></label>
        <label>Country <input type="text" name="country" placeholder="e.g., germany"></label>
      </fieldset>

      <fieldset>
        <legend>Diagnostics</legend>
        <label><input type="checkbox" id="vtOff"> Bypass VirusTotal (vt=off) — for testing only</label>
        <label><input type="checkbox" id="diagOn"> Diag mode (early echo)</label>
        <div class="help">Use these to isolate issues. Normally, leave off.</div>
      </fieldset>

      <!-- bot + diagnostics + base64 hidden fields -->
      <input type="hidden" name="website" value="">
      <input type="hidden" name="ttf_ms" id="ttf_ms" value="">
      <input type="hidden" name="vt" id="vt" value="">
      <input type="hidden" name="diag" id="diag" value="">

      <input type="hidden" name="sticker_b64" id="sticker_b64">
      <input type="hidden" name="sticker_name" id="sticker_name">
      <input type="hidden" name="sticker_type" id="sticker_type">

      <div class="row">
        <button type="submit" id="submitBtn">Upload</button>
        <span id="status" class="help"></span>
      </div>
    </form>

    <fieldset>
      <legend>Result</legend>
      <pre id="result">— waiting —</pre>
    </fieldset>

    <fieldset>
      <legend>Request (what we sent)</legend>
      <pre id="req">— waiting —</pre>
    </fieldset>

    <fieldset>
      <legend>Notes</legend>
      <div class="help">When a file exceeds 500 KB, this page downsizes & re-encodes to JPEG to meet the cap, then submits via base64. We blank the file field’s name so the server uses the base64 path.</div>
    </fieldset>
  </div>

  <script>
    (function(){
      var form = document.getElementById('tags_form');
      var fileInput = document.getElementById('sticker');
      var fileMsg = document.getElementById('fileMsg');
      var statusEl = document.getElementById('status');
      var resultEl = document.getElementById('result');
      var reqEl = document.getElementById('req');
      var showAction = document.getElementById('showAction');

      var vtOff = document.getElementById('vtOff');
      var diagOn = document.getElementById('diagOn');
      var vtField = document.getElementById('vt');
      var diagField = document.getElementById('diag');
      var ttfField = document.getElementById('ttf_ms');
      var submitBtn = document.getElementById('submitBtn');

      showAction.textContent = form.action;
      var t0 = Date.now();

      function syncToggles(){ vtField.value = vtOff.checked ? 'off' : ''; diagField.value = diagOn.checked ? '1' : ''; }
      vtOff.addEventListener('change', syncToggles);
      diagOn.addEventListener('change', syncToggles);
      syncToggles();

      function prettyBytes(n){ if(n==null)return''; var u=['B','KB','MB','GB'],i=0,v=n; while(v>=1024&&i<u.length-1){v/=1024;i++;} return (i?v.toFixed(1):v.toFixed(0))+' '+u[i]; }

      fileInput.addEventListener('change', function(){
        var f = fileInput.files && fileInput.files[0];
        if (!f){ fileMsg.textContent = ''; return; }
        var okType = (f.type === 'image/jpeg' || f.type === 'image/png');
        if (!okType){ fileMsg.innerHTML = '<span class="err">png/jpeg only</span>'; return; }
        if (f.size > 500*1024){
          fileMsg.innerHTML = 'selected: ' + f.name + ' (' + prettyBytes(f.size) + ') — will be optimized to ≤ 500 KB';
        } else {
          fileMsg.textContent = 'selected: ' + f.name + ' (' + prettyBytes(f.size) + ')';
        }
      });

      // helpers: base64 + image compression
      function fileToDataURL(file){
        return new Promise(function(resolve,reject){
          var r=new FileReader(); r.onload=function(){resolve(String(r.result||''));}; r.onerror=reject; r.readAsDataURL(file);
        });
      }
      function loadImage(url){ return new Promise(function(res,rej){ var img=new Image(); img.onload=function(){res(img)}; img.onerror=rej; img.src=url; }); }
      function b64Size(dataUrl){
        var i=dataUrl.indexOf('base64,'); if(i<0) return 0;
        var b64=dataUrl.slice(i+7); var pad=(/==?$/.exec(b64)||[''])[0].length;
        return Math.floor(b64.length*3/4)-pad;
      }
      async function downscaleToCap(file, capBytes, opts){
        opts=opts||{}; var maxDim=opts.maxDim||1600; var bg=opts.background||'#000';
        var src=await fileToDataURL(file); var img=await loadImage(src);
        var w=img.naturalWidth||img.width, h=img.naturalHeight||img.height;
        var best=null, tw=w, th=h, cv, cx;

        for (var round=0; round<3; round++){
          var scale=Math.min(1, maxDim/Math.max(w,h));
          tw=Math.max(1,Math.round(w*scale)); th=Math.max(1,Math.round(h*scale));
          cv=document.createElement('canvas'); cv.width=tw; cv.height=th;
          cx=cv.getContext('2d'); cx.fillStyle=bg; cx.fillRect(0,0,tw,th); cx.drawImage(img,0,0,tw,th);

          var lo=0.5, hi=0.95, bestLocal=null;
          for (var i=0;i<8;i++){
            var q=(lo+hi)/2;
            var data=cv.toDataURL('image/jpeg', q);
            var sz=b64Size(data);
            if (sz<=capBytes){ bestLocal={data:data,size:sz,q:q,w:tw,h:th}; lo=q; } else { hi=q; }
          }
          if (bestLocal && bestLocal.size<=capBytes){ best=bestLocal; break; }
          maxDim=Math.max(640, Math.floor(maxDim*0.8));
        }
        if (!best){
          var data=cv.toDataURL('image/jpeg', 0.4);
          best={data:data,size:b64Size(data),q:0.4,w:cv.width,h:cv.height};
        }
        return best;
      }

      form.addEventListener('submit', async function(ev){
        ttfField.value = String(Date.now() - t0);

        var f = fileInput.files && fileInput.files[0];
        if (!f){ ev.preventDefault(); statusEl.innerHTML = '<span class="err">no image selected</span>'; return; }
        if (!(f.type === 'image/jpeg' || f.type === 'image/png')){ ev.preventDefault(); statusEl.innerHTML = '<span class="err">png/jpeg only</span>'; return; }

        ev.preventDefault(); // manual submit
        submitBtn.disabled = true;
        statusEl.textContent = (f.size>500*1024) ? 'optimizing image…' : 'prepping upload…';

        try {
          var useCompressed=false, dataUrl='', outName=f.name||'upload';
          if (f.size > 500*1024){
            var best = await downscaleToCap(f, 500*1024, {maxDim:1600, background:'#000'});
            dataUrl = best.data; useCompressed=true;
            outName = outName.replace(/\.[a-z0-9]+$/i,'') + '.jpg';
            statusEl.textContent = 'optimized to ~' + prettyBytes(best.size) + ' ('+best.w+'×'+best.h+' @ q≈'+best.q.toFixed(2)+'), uploading…';
          } else {
            dataUrl = await fileToDataURL(f);
            statusEl.textContent = 'uploading…';
          }

          var parts = dataUrl.split(',', 2);
          document.getElementById('sticker_b64').value = parts[1] || '';
          document.getElementById('sticker_name').value = outName;
          document.getElementById('sticker_type').value = 'image/jpeg';

          if (useCompressed){ fileInput.setAttribute('data-orig-name','sticker'); fileInput.name = ''; }

          // Show payload snapshot
          try {
            var fd = new FormData(form), rows = [];
            fd.forEach(function(v,k){
              if (k === 'sticker_b64'){
                rows.push(k + ': [base64] ' + (String(v||'').length) + ' chars' + (useCompressed?' (optimized)':''));
              } else if (v && v.name){
                rows.push(k + ': [file] ' + v.name);
              } else { rows.push(k + ': ' + v); }
            });
            reqEl.textContent = rows.join('\n');
          } catch(e) { reqEl.textContent = '(could not read FormData: ' + e + ')'; }

          form.submit();
        } catch(e) {
          submitBtn.disabled = false;
          statusEl.innerHTML = '<span class="err">failed to read/optimize image</span>';
        }
      });

      window.addEventListener('message', function(e){
        var okOrigin = /^https:\/\/script\.google\.com$/.test(e.origin)
          || /^https:\/\/([a-z0-9-]+\.)*googleusercontent\.com$/.test(e.origin);
        if (!okOrigin) return;

        submitBtn.disabled = false;

        // restore file input name if blanked
        if (!fileInput.name && fileInput.getAttribute('data-orig-name')) {
          fileInput.name = fileInput.getAttribute('data-orig-name'); fileInput.removeAttribute('data-orig-name');
        }

        try { resultEl.textContent = JSON.stringify(e.data, null, 2); }
        catch (err) { resultEl.textContent = 'Error parsing message: ' + err; }

        if (e && e.data && e.data.ok) {
          statusEl.innerHTML = '<span class="ok">uploaded</span>';
        } else if (e && e.data && e.data.error) {
          statusEl.innerHTML = '<span class="err">' + String(e.data.error) + '</span>';
        } else {
          statusEl.textContent = '';
        }
      });
    })();
  </script>
</body>
</html>
