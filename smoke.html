<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Smoke Test — Tags Uploader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{ --fg:#0f0; --bg:#000; --mut:#8f8; }
    html,body{ margin:0; background:var(--bg); color:var(--fg); font:14px/1.4 monospace; }
    .wrap{ max-width:900px; margin:24px auto; padding:0 16px; }
    h1{ margin:0 0 16px 0; font-size:18px; }
    fieldset{ border:1px dashed var(--fg); padding:12px; margin:14px 0; }
    legend{ padding:0 6px; color:var(--mut); }
    label{ display:block; margin:8px 0; }
    .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    input[type="text"]{ padding:6px 8px; border:1px solid var(--fg); background:transparent; color:var(--fg); width:280px; }
    input[type="file"]{ color:var(--fg); }
    button{ padding:8px 14px; border:1px solid var(--fg); background:transparent; color:var(--fg); cursor:pointer; }
    button:hover{ background:#002800; }
    .help{ color:var(--mut); font-style:italic; }
    pre{ white-space:pre-wrap; word-break:break-word; background:#001800; padding:8px; border:1px dashed var(--fg); }
    iframe{ width:100%; height:110px; border:1px dashed var(--fg); background:#050; }
    .pill{ display:inline-block; border:1px solid var(--fg); padding:2px 6px; margin-left:6px; color:var(--mut); }
    .err{ color:#f66; }
    .ok{ color:#7f7; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Smoke Test — Tags Uploader
      <span class="pill" id="showAction"></span>
    </h1>

    <!-- hidden iframe target so the page doesn't navigate away -->
    <iframe name="upload_iframe" id="upload_iframe"></iframe>

    <form id="tags_form"
      action="https://script.google.com/macros/s/AKfycbxv3FKB0P30wixxKJUfYvTnCW9vzqgar4JV7PArIpirC9lk7Srpqe3SNDKIcCIvjs_4/exec"
      method="POST" enctype="multipart/form-data" target="upload_iframe" novalidate>

      <fieldset>
        <legend>File</legend>
        <div class="row">
          <input id="sticker" type="file" name="sticker" accept=".jpg,.jpeg,.png" required>
          <span id="fileMsg" class="help"></span>
        </div>
        <div class="help">Only JPEG/PNG, max 5 MB</div>
      </fieldset>

      <fieldset>
        <legend>Metadata</legend>
        <label>Place of tag <input type="text" name="title" placeholder="e.g., zërgë coffeeshop"></label>
        <label>City <input type="text" name="city" placeholder="e.g., berlin"></label>
        <label>Country <input type="text" name="country" placeholder="e.g., germany"></label>
      </fieldset>

      <fieldset>
        <legend>Diagnostics</legend>
        <label><input type="checkbox" id="vtOff"> Bypass VirusTotal (vt=off) — for testing only</label>
        <label><input type="checkbox" id="diagOn"> Diag mode (early echo)</label>
        <div class="help">Turn these on to isolate issues. Normally, leave them off</div>
      </fieldset>

      <!-- bot + diagnostics hidden fields -->
      <input type="hidden" name="website" value="">
      <input type="hidden" name="ttf_ms" id="ttf_ms" value="">
      <input type="hidden" name="vt" id="vt" value="">
      <input type="hidden" name="diag" id="diag" value="">

      <!-- base64 fallback fields -->
      <input type="hidden" name="sticker_b64" id="sticker_b64">
      <input type="hidden" name="sticker_name" id="sticker_name">
      <input type="hidden" name="sticker_type" id="sticker_type">

      <div class="row">
        <button type="submit" id="submitBtn">Upload</button>
        <span id="status" class="help"></span>
      </div>
    </form>

    <fieldset>
      <legend>Result</legend>
      <pre id="result">— waiting —</pre>
    </fieldset>

    <fieldset>
      <legend>Request (what we sent)</legend>
      <pre id="req">— waiting —</pre>
    </fieldset>

    <fieldset>
      <legend>Raw iframe response (from Apps Script)</legend>
      <div class="help">This is the tiny HTML your script returns into the hidden iframe and then postMessages back</div>
    </fieldset>
  </div>

  <script>
    (function(){
      var form = document.getElementById('tags_form');
      var fileInput = document.getElementById('sticker');
      var fileMsg = document.getElementById('fileMsg');
      var statusEl = document.getElementById('status');
      var resultEl = document.getElementById('result');
      var reqEl = document.getElementById('req');
      var showAction = document.getElementById('showAction');

      var vtOff = document.getElementById('vtOff');
      var diagOn = document.getElementById('diagOn');
      var vtField = document.getElementById('vt');
      var diagField = document.getElementById('diag');
      var ttfField = document.getElementById('ttf_ms');
      var submitBtn = document.getElementById('submitBtn');

      // base64 fallback fields
      var b64El = document.getElementById('sticker_b64');
      var nameEl = document.getElementById('sticker_name');
      var typeEl = document.getElementById('sticker_type');

      // show the current form action
      showAction.textContent = form.action;

      // mark when the user landed (for ttf_ms)
      var t0 = Date.now();

      // Handle toggle checkboxes -> hidden fields
      function syncToggles(){
        vtField.value = vtOff.checked ? 'off' : '';
        diagField.value = diagOn.checked ? '1' : '';
      }
      vtOff.addEventListener('change', syncToggles);
      diagOn.addEventListener('change', syncToggles);
      syncToggles();

      // Pretty file size
      function prettyBytes(n){
        if (n == null) return '';
        var u=['B','KB','MB','GB']; var i=0, v=n;
        while (v>=1024 && i<u.length-1){ v/=1024; i++; }
        return (i ? v.toFixed(1) : v.toFixed(0)) + ' ' + u[i];
      }

      // base64 helper
      function readFileToBase64(file){
        return new Promise(function(resolve, reject){
          var r = new FileReader();
          r.onload = function(){ resolve(String(r.result||'')); };
          r.onerror = reject;
          r.readAsDataURL(file);
        });
      }

      // show selection + enforce 5 MB cap + jpeg/png only
      fileInput.addEventListener('change', function(){
        var f = fileInput.files && fileInput.files[0];
        if (!f){ fileMsg.textContent = ''; return; }
        var okType = (f.type === 'image/jpeg' || f.type === 'image/png');
        if (!okType){
          fileMsg.innerHTML = '<span class="err">png/jpeg only</span>';
          return;
        }
        if (f.size > 5*1024*1024){
          fileMsg.innerHTML = '<span class="err">file size limit: 5 MB</span>';
          return;
        }
        fileMsg.textContent = 'selected: ' + f.name + ' (' + prettyBytes(f.size) + ')';
      });

      // before submit: set ttf_ms, validate, fill base64, then submit
      form.addEventListener('submit', async function(ev){
        // stop the native submit until fields are prepared
        ev.preventDefault();

        ttfField.value = String(Date.now() - t0);

        var f = fileInput.files && fileInput.files[0];
        if (!f){
          statusEl.innerHTML = '<span class="err">no image selected</span>';
          return;
        }
        if (!(f.type === 'image/jpeg' || f.type === 'image/png')){
          statusEl.innerHTML = '<span class="err">png/jpeg only</span>';
          return;
        }
        if (f.size > 5*1024*1024){
          statusEl.innerHTML = '<span class="err">file size limit: 5 MB</span>';
          return;
        }

        // Fill base64 fallback so server succeeds even if e.files is empty
        try{
          var dataUrl = await readFileToBase64(f);
          var parts = dataUrl.split(',', 2);
          b64El.value = parts[1] || '';
          nameEl.value = f.name || 'upload';
          typeEl.value = f.type || 'application/octet-stream';
        }catch(e){
          statusEl.innerHTML = '<span class="err">failed to read file</span>';
          return;
        }

        // Show what we’re sending (FormData), elide huge base64
        try {
          var fd = new FormData(form), rows = [];
          fd.forEach(function(v,k){
            if (k === 'sticker_b64'){
              rows.push(k + ': [base64] ' + (String(v||'').length) + ' chars');
            } else if (v && v.name){
              rows.push(k + ': [file] ' + v.name);
            } else {
              rows.push(k + ': ' + v);
            }
          });
          reqEl.textContent = rows.join('\n');
        } catch(e) {
          reqEl.textContent = '(could not read FormData: ' + e + ')';
        }

        // UI feedback and now actually submit
        submitBtn.disabled = true;
        statusEl.textContent = 'uploading…';
        resultEl.textContent = '— waiting for server —';

        // perform the real submit only after fields are filled
        form.submit();
      });

      // receive postMessage from the Apps Script iframe
      window.addEventListener('message', function(e){
        var okOrigin = /^https:\/\/script\.google\.com$/.test(e.origin)
          || /^https:\/\/([a-z0-9-]+\.)*googleusercontent\.com$/.test(e.origin);
        if (!okOrigin) return;

        submitBtn.disabled = false;

        try {
          resultEl.textContent = JSON.stringify(e.data, null, 2);
        } catch (err) {
          resultEl.textContent = 'Error parsing message: ' + err;
        }

        if (e && e.data && e.data.ok) {
          statusEl.innerHTML = '<span class="ok">uploaded</span>';
        } else if (e && e.data && e.data.error) {
          statusEl.innerHTML = '<span class="err">' + String(e.data.error) + '</span>';
        } else {
          statusEl.textContent = '';
        }
      });
    })();
  </script>
</body>
</html>
