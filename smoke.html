<!doctype html>
<meta charset="utf-8">
<title>GAS Upload Smoke Test (base64 fallback)</title>
<style>
  body { font: 16px/1.5 system-ui, sans-serif; max-width: 800px; margin: 24px auto; }
  .row { margin: 12px 0; }
  pre { background: #111; color: #0f0; padding: 12px; min-height: 140px; white-space: pre-wrap; }
  iframe { width: 100%; height: 220px; border: 1px solid #ccc; }
</style>

<h1>GAS Upload Smoke Test (with base64 fallback)</h1>

<form class="row"
      action="https://script.google.com/macros/s/AKfycbxv3FKB0P30wixxKJUfYvTnCW9vzqgar4JV7PArIpirC9lk7Srpqe3SNDKIcCIvjs_4/exec"
      method="POST" enctype="multipart/form-data" target="result_iframe">
  <div class="row">
    <label>Choose file:
      <input id="sticker" type="file" name="sticker" accept=".png,.jpg,.jpeg,.webp" required>
    </label>
  </div>
  <!-- base64 fallback fields -->
  <input type="hidden" name="sticker_b64" id="sticker_b64">
  <input type="hidden" name="sticker_name" id="sticker_name">
  <input type="hidden" name="sticker_type" id="sticker_type">

  <div class="row">
    <input type="text" name="title" placeholder="title">
    <input type="text" name="city" placeholder="city">
    <input type="text" name="country" placeholder="country">
  </div>
  <div class="row">
    <button id="btn" type="submit">Upload</button>
  </div>
</form>

<h3>Result (postMessage)</h3>
<pre id="out">(ready — pick a file, then Upload)</pre>

<h3>Raw iframe response</h3>
<iframe name="result_iframe" id="result_iframe"></iframe>

<script>
  const input = document.getElementById('sticker');
  const b64   = document.getElementById('sticker_b64');
  const nEl   = document.getElementById('sticker_name');
  const tEl   = document.getElementById('sticker_type');
  const btn   = document.getElementById('btn');
  let reading = false;

  function readFileToBase64(file) {
    return new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(String(r.result || ''));
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  document.querySelector('form').addEventListener('submit', async (e) => {
    const f = input.files && input.files[0];
    if (!f) { e.preventDefault(); return; }

    // keep files modest for base64 (<= 5 MB)
    if (f.size > 5 * 1024 * 1024) {
      e.preventDefault();
      alert('Please use an image ≤ 5 MB for this test.');
      return;
    }

    // If base64 not prepared yet, prepare it first, then re-submit
    if (!b64.value && !reading) {
      e.preventDefault();
      reading = true;
      btn.disabled = true;
      try {
        const dataUrl = await readFileToBase64(f);
        const parts = dataUrl.split(',', 2);
        b64.value = parts[1] || '';
        nEl.value = f.name || 'upload';
        tEl.value = f.type || 'application/octet-stream';
        reading = false;
        btn.disabled = false;
        e.target.submit(); // submit again, now with base64 fields populated
      } catch (err) {
        reading = false;
        btn.disabled = false;
        alert('Failed to read file');
      }
    }
  });

  // Show postMessage results from the Apps Script response (sent from the iframe)
  window.addEventListener('message', function (e) {
    const okOrigin = /^https:\/\/script\.google\.com$/.test(e.origin) ||
                     /^https:\/\/([a-z0-9-]+\.)*googleusercontent\.com$/.test(e.origin);
    if (!okOrigin) return;
    const out = document.getElementById('out');
    try { out.textContent = JSON.stringify(e.data, null, 2); }
    catch { out.textContent = String(e.data); }
  });
</script>
